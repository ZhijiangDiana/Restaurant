<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta name="full-screen" content="yes">
    <meta content="default" name="apple-mobile-web-app-status-bar-style">
    <meta name="screen-orientation" content="portrait">
    <meta name="browsermode" content="application">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <base target="_blank">
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="css/chat.css">
</head>

<body>
<div class="container" id="app">
    <!-- é“ƒé“›å›¾æ ‡ -->
    <div class="notification-bell" @click="showNotifications">
        <i class="bell-icon">ğŸ””</i>
    </div>

    <!-- ç”¨æˆ·åå­—åˆ—è¡¨ -->
    <div class="names-list">
        <ul>
            <li v-for="user in allUserList" :key="user.userId">
                {{ user.username }}
                <button @click.stop="showChat(user)">å‘é€ä¿¡æ¯</button>
            </li>

        </ul>
    </div>

    <button id="chatToggle" @click="toggleChat">æ‰“å¼€èŠå¤©æ¡†</button>

    <div v-if="isShowChat" class="chat-panel">
        <!-- èŠå¤©å¤´éƒ¨ -->
        <div class="chat-header">
            <div id="chatMes" v-show="chatMes">
                æ­£åœ¨å’Œ <span class="chat-partner-name">{{toName}}</span> èŠå¤©
            </div>
        </div>

        <!-- èŠå¤©ä¸»ä½“ -->
        <div class="chat-body">
            <div class="chat-area" id="chatArea" v-show="isShowChat">
                <!-- èŠå¤©æ¶ˆæ¯å±•ç¤ºåŒºåŸŸ -->
                <div class="chat-messages" id="show">
                    <div class="pnl-list" id="msgs" v-for="message in historyMessage">
                        <!-- æ¶ˆæ¯å±•ç¤º -->
                        <div class="msg guest" v-if="message.fromName">
                            <div class="msg-right">
                                <div class="msg-host photo"
                                     style="background-image: url(img/avatar/Member003.jpg)"></div>
                                <div class="msg-ball">{{message.message}}</div>
                            </div>
                        </div>
                        <div class="msg robot" v-else>
                            <div class="msg-left" worker="">
                                <div class="msg-host photo"
                                     style="background-image: url(img/avatar/Member002.jpg)"></div>
                                <div class="msg-ball">{{message.message}}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input">
                    <textarea id="context_text" @keyup.enter="submit" placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—ä¿¡æ¯..." v-model="sendMessage.message"></textarea>
                    <button class="send-button" id="submit" @click="submit">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- èŠå¤©ä¾§è¾¹æ  -->
        <div class="chat-sidebar">
            <div class="friends-list">
                <div class="chat-sidebar">
                    <div class="friends-list">
                        <ul>
                            å†å²è®°å½•<br><br>
                            <li v-for="user in relatedUserList" @click='showChat(user)'>{{ user.username }}åœ¨çº¿</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/vue.js"></script>
<script src="js/axios-0.18.0.js"></script>
<script>
    let ws;

    new Vue({
        el: "#app",
        data() {
            return {
                unreadMessages: [], // å­˜å‚¨æœªè¯»æ¶ˆæ¯
                isShowChat: false,
                allUserList: [], // å­˜å‚¨ç”¨æˆ·åˆ—è¡¨
                relatedUserList:[],// å’Œæˆ‘é€šè¿‡è¯çš„
                selectedUser: null, // å½“å‰é€‰ä¸­çš„ç”¨æˆ·å¯¹è±¡
                chatMes: false,
                isOnline: true,
                username: "",
                userId: "", // å‡è®¾æ‚¨åœ¨æŸå¤„è®¾ç½®äº†å½“å‰ç™»å½•ç”¨æˆ·çš„ID
                toName: "",
                sendMessage: {
                    fromId: "",
                    toName: "",
                    toId: "",
                    message: ""
                },
                inputMessage: "",
                historyMessage: [],
                friendsList: [],
                systemMessages: []
            };
        },
        created() {
            this.fetchAllUserList();
            this.initWebSocket();   //
            // æ¨¡æ‹Ÿè®¾ç½®å½“å‰ç”¨æˆ·çš„IDï¼Œå®é™…æƒ…å†µåº”ä»ç™»å½•ä¿¡æ¯ä¸­è·å–
            this.fetchUserId();
            this.fetchRelatedUserList();
        },
        methods: {
            async fetchUserId(){
                const response = await axios.get('/restaurant/fetchUserId');
                this.userId = response.data;
            },
            async fetchAllUserList() {
                try {
                    const response = await axios.get('/restaurant/fetchPeople');
                    this.allUserList = response.data.object; // å‡è®¾åç«¯ç›´æ¥è¿”å›ç”¨æˆ·åˆ—è¡¨æ•°ç»„
                } catch (error) {
                    console.error('Error fetching user list:', error);
                }
            },
            fetchRelatedUserList(){
                alert(this.userId)
                axios.get('/restaurant/fetchPeople?userId=' + this.userId)
                    .then(response => {
                        this.relatedUserList = response.data.object;
                    })
                    .catch(error => {
                        console.error('Error fetching history messages:', error);
                    });
            },
            initWebSocket() {
                ws = new WebSocket(`ws://localhost:8080/restaurant/chat`);
                ws.onopen = this.onOpen;
                ws.onmessage = this.onMessage;
                ws.onclose = this.onClose;
            },
            toggleChat() {
                this.isShowChat = !this.isShowChat; // åˆ‡æ¢èŠå¤©æ¡†çš„æ˜¾ç¤ºçŠ¶æ€
            },
            showNotifications() {
                this.fetchRelatedUserList()
                this.isShowChat = true;
                this.initWebSocket(0)
                // è¿™é‡Œå¯ä»¥å¤„ç†æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯çš„é€»è¾‘
            },
            showChat(user) {
                this.selectedUser = user;
                if (user.username === undefined){
                    this.toName = user;
                }
                else {
                    this.toName = user.username;
                }
                this.initWebSocket(); // å‡è®¾userå¯¹è±¡æœ‰userIdå±æ€§
                this.isShowChat = true;
                this.chatMes = true;
                this.fetchHistoryMessages(user.userId);
            },
            fetchHistoryMessages(toId) {
                alert("å½“å‰ç”¨æˆ·" + this.userId + "å¯¹æ–¹id" + toId)
                axios.get('/restaurant/getOfflineMessages?fromId=' + this.userId + '&toId=' + toId)
                    .then(response => {
                        this.historyMessage = response.data;
                    })
                    .catch(error => {
                        console.error('Error fetching history messages:', error);
                    });
            },
            submit() {
                if(this.selectedUser) {
                    this.sendMessage.fromId = this.userId;
                    this.sendMessage.toId = this.selectedUser.userId;
                    this.sendMessage.toName = this.selectedUser.username;
                    this.$nextTick(() => {
                        this.sendMessage.message = "";
                    });
                    ws.send(JSON.stringify(this.sendMessage));
                    this.sendMessage.message = "";
                    this.fetchHistoryMessages(this.selectedUser.userId)
                }
            },
            onOpen() {
                this.isOnline = true;
            },
            onClose() {
                this.isOnline = false;
            },
            onMessage(evt) {
                const res = JSON.parse(evt.data);
                if(res.system) {
                    // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
                    var names = res.message;
                    this.friendsList = [];
                    this.systemMessages = [];
                    for (let i = 0; i < names.length; i++) {
                        if (names[i] != this.username) {
                            this.friendsList.push(names[i]);
                            this.systemMessages.push(names[i]);
                        }
                    }
                }else {
                    if(res.message === 0 || res.message === null){
                        alert("ä»Šå¤•æ˜¯ä½•å¹´")
                        this.fetchHistoryMessages(res.fromName);
                    }
                    else {
                        //éç³»ç»Ÿæ¶ˆæ¯ ä¸”åŒæ–¹éƒ½åœ¨çº¿,å­˜åœ¨æµè§ˆå™¨çš„sessioné‡Œ,ä¸å­˜æ•°æ®åº“é‡Œ
                        var history = sessionStorage.getItem(res.fromName);
                        // if (!history) {
                        //     this.historyMessage = [res];
                        // } else {
                            this.historyMessage.push(res);
                        // }
                        sessionStorage.setItem(res.fromName, JSON.stringify(this.historyMessage));
                    }
                }
            }
        }
    });
</script>

</body>
</html>